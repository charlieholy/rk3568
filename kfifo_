#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/kfifo.h>
#include <linux/types.h>

// 核心修复：定义16个char元素的kfifo（适配元素计数逻辑）
DECLARE_KFIFO(demo_fifo, char, 16);

// 测试数据：缩短为1字节（先验证基本功能），后续可扩展到16字节
static const char test_data = 'A';  // 单字符，长度1
static char read_buf;               // 单字符缓冲区

static int __init kfifo_demo_init(void)
{
    unsigned int avail, used;
    unsigned int ret;

    printk(KERN_INFO "===== kfifo demo start =====\n");
    printk(KERN_INFO "kfifo created (16 char elements)\n");

    // 1. 查看初始状态（验证可用空间）
    avail = kfifo_avail(&demo_fifo);
    used = kfifo_len(&demo_fifo);
    printk(KERN_INFO "Initial state - avail: %u, used: %u\n", avail, used);

    // 2. 单字符入队（适配1字节可用空间）
    ret = kfifo_in(&demo_fifo, &test_data, 1);
    if (ret != 1) {
        printk(KERN_ERR "kfifo_in failed! wrote: %u, expected: 1\n", ret);
        return -EIO;
    }
    printk(KERN_INFO "Write data: '%c' (len: 1)\n", test_data);

    // 3. 入队后状态
    avail = kfifo_avail(&demo_fifo);
    used = kfifo_len(&demo_fifo);
    printk(KERN_INFO "After write - avail: %u, used: %u\n", avail, used);

    // 4. 单字符出队
    ret = kfifo_out(&demo_fifo, &read_buf, 1);
    if (ret != 1) {
        printk(KERN_ERR "kfifo_out failed! read: %u, expected: 1\n", ret);
        return -EIO;
    }
    printk(KERN_INFO "Read data: '%c' (len: 1)\n", read_buf);

    // 5. 出队后状态
    avail = kfifo_avail(&demo_fifo);
    used = kfifo_len(&demo_fifo);
    printk(KERN_INFO "After read - avail: %u, used: %u\n", avail, used);

    printk(KERN_INFO "===== kfifo demo init success =====\n");
    return 0;
}

static void __exit kfifo_demo_exit(void)
{
    printk(KERN_INFO "kfifo demo exit (static kfifo no need free)\n");
    printk(KERN_INFO "===== kfifo demo exit =====\n");
}

module_init(kfifo_demo_init);
module_exit(kfifo_demo_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Demo");

[  242.434906] ===== kfifo demo start =====
[  242.434941] kfifo created (16 char elements)
[  242.434949] Initial state - avail: 1, used: 0
[  242.434955] Write data: 'A' (len: 1)
[  242.434962] After write - avail: 0, used: 1
[  242.434967] Read data: '' (len: 1)
[  242.434974] After read - avail: 1, used: 0
[  242.434979] ===== kfifo demo init success =====

MODULE_DESCRIPTION("kfifo demo for old ARM64 kernel (element count)");
