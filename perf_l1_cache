# 1. 安装火焰图工具（RK3568需先装git）
git clone https://github.com/brendangregg/FlameGraph.git
cd FlameGraph

# 2. 采样L1d未命中事件，生成perf.data
perf record -e L1-dcache-load-misses -g -F 1000 ./snd

# 3. 转换为火焰图格式
perf script | ./stackcollapse-perf.pl > l1_miss.fold
./flamegraph.pl l1_miss.fold > l1_miss.svg

# 4. 将svg文件传到PC端，用浏览器打开查看

如果通过 perf 发现你的 ALSA 音频程序有 L1 缓存命中率低的问题，可针对性调优，核心方向：
内存访问连续化：你的程序中有pcm_buf数组的读写，确保数组是连续的物理内存（嵌入式中用dma_alloc_coherent代替malloc，避免内存碎片化，提升 L1d 命中率）；
数据对齐：L1 缓存的行大小通常为 64 字节（Cortex-A55），将pcm_buf按 64 字节对齐（用__attribute__((aligned(64)))），避免跨缓存行访问；
减少随机读写：你的print_pcm_hex函数中有大量的循环打印，减少循环内的内存随机访问，将数据批量读取后再处理；
指令优化：如果 L1i 未命中高，可优化函数内联（inline），减少函数调用的指令跳转，提升 L1i 缓存的指令命中率；
数据分块：若处理的 PCM 数据量较大，将数据分块为 L1 缓存大小的倍数（Cortex-A55 的 L1d 为 32KB / 核，L1i 为 32KB / 核），避免缓存溢出。

Flame Graph
Search
ic
clk_core_get_pa..
[snd]
vprintk_emit
__arm64_sys_exit_group
free_unref_page
el0_svc_common.constp..
rockchip_i2s_td..
work_pending
[libasound.so.2.0.0]
__..
_r..
[snd]
vprintk_default
vprintk_func
snd_pcm_ioctl
snd_pcm_release
[libasound.so.2.0.0]
[libc.so.6]
snd
el0_svc_common...
el0_svc
clk_mux_determi..
clk_core_determ..
rk817_digital_m..
__clk_lookup_su..
_r..
[snd]
i2..
do_notify_resume
free_pages
[libc.so.6]
____fput
__arm64_sys_ioctl
i2..
snd_pcm_prepare
el0_svc
__wake_up_parent
[libc.so.6]
unmap_page_range
clk_core_round_..
snd_pcm_common_ioctl
printk
