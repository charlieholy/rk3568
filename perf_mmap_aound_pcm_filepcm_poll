æ¨¡å—	æ—¶é—´å•å…ƒ	æ¯å•å…ƒå¸§æ•°	æ ¸å¿ƒç‰¹ç‚¹
FreeSWITCH	20ms	320 å¸§	æŒ‰å›ºå®šæ—¶é—´å‘åŒ…ï¼Œæ•°æ®ç¦»æ•£
ALSA æ’­æ”¾å™¨	32ms	512 å¸§	æŒ‰ç¡¬ä»¶èŠ‚å¥è¦æ•°æ®ï¼Œéœ€è¿ç»­


#include <alsa/asoundlib.h>
#include <math.h> 
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <time.h>  
#include <poll.h>  // pollæ‰€éœ€å¤´æ–‡ä»¶

// WAVæ–‡ä»¶å¤´ç»“æ„ä½“
typedef struct {
    char        riff_id[4];        
    uint32_t    riff_size;         
    char        riff_type[4];      
    char        fmt_id[4];         
    uint32_t    fmt_size;          
    uint16_t    audio_format;      
    uint16_t    channels;          
    uint32_t    sample_rate;       
    uint32_t    byte_rate;         
    uint16_t    block_align;       
    uint16_t    bits_per_sample;   
    char        data_id[4];        
    uint32_t    data_size;         
} WavHeader;

// å…¨å±€å˜é‡
FILE *wav_file = NULL;
WavHeader wav_header;
snd_pcm_format_t wav_format;
int wav_frame_bytes;          // WAVæ–‡ä»¶åŸå§‹æ¯å¸§å­—èŠ‚æ•°
int playback_frame_bytes;     // æ’­æ”¾æ—¶ï¼ˆåŒå£°é“ï¼‰æ¯å¸§å­—èŠ‚æ•°
double wav_total_seconds;

// ä»WAVæ–‡ä»¶è¯»å–åŸå§‹éŸ³é¢‘æ•°æ®
int read_wav_audio(void *buf, snd_pcm_uframes_t frames) {
    if (!wav_file || feof(wav_file)) {
        return 0;
    }
    size_t read_bytes = frames * wav_frame_bytes;
    size_t ret = fread(buf, 1, read_bytes, wav_file);
    if (ret < read_bytes) {
        memset((char*)buf + ret, 0, read_bytes - ret);
    }
    return ret / wav_frame_bytes;
}

// å•å£°é“è½¬åŒå£°é“
void mono_to_stereo(short *mono_buf, short *stereo_buf, snd_pcm_uframes_t frames) {
    for (snd_pcm_uframes_t i = 0; i < frames; i++) {
        stereo_buf[i * 2] = mono_buf[i];    
        stereo_buf[i * 2 + 1] = mono_buf[i];
    }
}

// è§£æWAVå¤´
int parse_wav_header(const char *wav_path) {
    wav_file = fopen(wav_path, "rb");
    if (!wav_file) {
        fprintf(stderr, "æ‰“å¼€WAVæ–‡ä»¶å¤±è´¥: %s\n", wav_path);
        return -1;
    }

    size_t ret = fread(&wav_header, 1, sizeof(WavHeader), wav_file);
    if (ret != sizeof(WavHeader)) {
        fprintf(stderr, "è¯»å–WAVå¤´å¤±è´¥\n");
        fclose(wav_file);
        return -1;
    }

    // éªŒè¯æ ¼å¼
    if (memcmp(wav_header.riff_id, "RIFF", 4) != 0 ||
        memcmp(wav_header.riff_type, "WAVE", 4) != 0 ||
        memcmp(wav_header.fmt_id, "fmt ", 4) != 0 ||
        memcmp(wav_header.data_id, "data", 4) != 0) {
        fprintf(stderr, "ä¸æ˜¯æ ‡å‡†WAVæ–‡ä»¶\n");
        fclose(wav_file);
        return -1;
    }
    if (wav_header.audio_format != 1) {
        fprintf(stderr, "ä»…æ”¯æŒPCMéå‹ç¼©æ ¼å¼\n");
        fclose(wav_file);
        return -1;
    }
    if (wav_header.bits_per_sample != 16) {
        fprintf(stderr, "ä»…æ”¯æŒ16ä½WAV\n");
        fclose(wav_file);
        return -1;
    }

    // åˆå§‹åŒ–å‚æ•°
    wav_format = SND_PCM_FORMAT_S16_LE;
    wav_frame_bytes = wav_header.channels * (wav_header.bits_per_sample / 8);
    playback_frame_bytes = 2 * (wav_header.bits_per_sample / 8);
    wav_total_seconds = (double)wav_header.data_size / wav_header.byte_rate;

    // æ‰“å°ä¿¡æ¯
    printf("\n===== WAVæ–‡ä»¶ä¿¡æ¯ =====\n");
    printf("åŸå§‹å£°é“æ•°: %d\n", wav_header.channels);
    printf("æ’­æ”¾å£°é“æ•°: 2ï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰\n");
    printf("é‡‡æ ·ç‡: %d Hz\n", wav_header.sample_rate);
    printf("ä½æ·±: %d bit\n", wav_header.bits_per_sample);
    printf("éŸ³é¢‘æ•°æ®å¤§å°: %d å­—èŠ‚\n", wav_header.data_size);
    printf("å®é™…æ—¶é•¿: %.2f ç§’\n", wav_total_seconds);
    printf("========================\n\n");

    return 0;
}

#define PCM_DEVICE "hw:1,0"  
#define BUFFER_FRAMES 1024

// è·å–å½“å‰æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
uint64_t get_current_ms() {
    struct timespec ts;
    clock_gettime(CLOCK_MONOTONIC, &ts);
    return (uint64_t)ts.tv_sec * 1000 + ts.tv_nsec / 1000000;
}

int main(int argc, char *argv[]) {
    if (argc != 2) {
        fprintf(stderr, "ç”¨æ³•: %s <WAVæ–‡ä»¶è·¯å¾„>\n", argv[0]);
        return -1;
    }

    snd_pcm_t *pcm_handle = NULL;
    void *wav_buf = NULL;       
    void *playback_buf = NULL;  
    snd_pcm_uframes_t frames_written = 0;
    int ret;

    // pollç›¸å…³å˜é‡
    struct pollfd *pfds = NULL;
    int pcm_poll_fd_count = 0;

    // 1. è§£æWAV
    if (parse_wav_header(argv[1]) < 0) {
        return -1;
    }
    snd_pcm_uframes_t total_frames = wav_header.data_size / wav_frame_bytes;

    // 2. æ‰“å¼€PCMè®¾å¤‡
    ret = snd_pcm_open(&pcm_handle, PCM_DEVICE, SND_PCM_STREAM_PLAYBACK, 0);
    if (ret < 0) {
        fprintf(stderr, "æ‰“å¼€è®¾å¤‡å¤±è´¥: %s\n", snd_strerror(ret));
        fclose(wav_file);
        return -1;
    }

    // åˆå§‹åŒ–pollæè¿°ç¬¦ï¼ˆé€‚é…3å‚æ•°ç‰ˆALSAåº“ï¼‰
    pcm_poll_fd_count = snd_pcm_poll_descriptors_count(pcm_handle);
    pfds = malloc(pcm_poll_fd_count * sizeof(struct pollfd));
    if (!pfds) {
        fprintf(stderr, "åˆ†é…pollæè¿°ç¬¦å†…å­˜å¤±è´¥\n");
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }
    // å…³é”®ä¿®æ­£ï¼šå»æ‰ç¬¬å››ä¸ªå‚æ•°POLLOUTï¼Œé€‚é…æ—§ç‰ˆALSAåº“
    ret = snd_pcm_poll_descriptors(pcm_handle, pfds, pcm_poll_fd_count);
    if (ret < 0) {
        fprintf(stderr, "è·å–pollæè¿°ç¬¦å¤±è´¥: %s\n", snd_strerror(ret));
        free(pfds);
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    // 3. é…ç½®PCMå‚æ•°ï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰
    snd_pcm_hw_params_t *hw_params;
    snd_pcm_hw_params_alloca(&hw_params);
    snd_pcm_hw_params_any(pcm_handle, hw_params);
    
    ret = snd_pcm_hw_params_set_access(pcm_handle, hw_params, SND_PCM_ACCESS_MMAP_INTERLEAVED);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®MMAPæ¨¡å¼å¤±è´¥: %s\n", snd_strerror(ret));
        free(pfds);
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    ret = snd_pcm_hw_params_set_format(pcm_handle, hw_params, wav_format);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®æ ¼å¼å¤±è´¥: %s\n", snd_strerror(ret));
        free(pfds);
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    ret = snd_pcm_hw_params_set_channels(pcm_handle, hw_params, 2);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®åŒå£°é“å¤±è´¥: %s\n", snd_strerror(ret));
        free(pfds);
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    unsigned int rate = wav_header.sample_rate;
    ret = snd_pcm_hw_params_set_rate_near(pcm_handle, hw_params, &rate, 0);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®é‡‡æ ·ç‡å¤±è´¥: %s\n", snd_strerror(ret));
        free(pfds);
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }
    if (rate != wav_header.sample_rate) {
        printf("è­¦å‘Šï¼šé‡‡æ ·ç‡ä¸åŒ¹é…ï¼Œä½¿ç”¨ %d Hz æ›¿ä»£ %d Hz\n", rate, wav_header.sample_rate);
    }
    
    // ä¼˜åŒ–ç¼“å†²åŒºå¤§å°
    snd_pcm_uframes_t period_frames = 512;
    snd_pcm_hw_params_set_period_size_near(pcm_handle, hw_params, &period_frames, 0);
    snd_pcm_uframes_t buffer_frames = period_frames * 2;
    snd_pcm_hw_params_set_buffer_size_near(pcm_handle, hw_params, &buffer_frames);

    ret = snd_pcm_hw_params(pcm_handle, hw_params);
    if (ret < 0) {
        fprintf(stderr, "åº”ç”¨å‚æ•°å¤±è´¥: %s\n", snd_strerror(ret));
        free(pfds);
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    // æ‰“å°PCMå‚æ•°
    printf("\n===== PCMç¡¬ä»¶å‚æ•° =====\n");
    snd_pcm_access_t access;
    snd_pcm_hw_params_get_access(hw_params, &access);
    printf("1. è®¿é—®æ¨¡å¼: %s\n", access == SND_PCM_ACCESS_MMAP_INTERLEAVED ? "MMAP_INTERLEAVED" : "å…¶ä»–");
    snd_pcm_format_t format;
    snd_pcm_hw_params_get_format(hw_params, &format);
    printf("2. é‡‡æ ·æ ¼å¼: %s\n", snd_pcm_format_name(format));
    unsigned int channels;
    snd_pcm_hw_params_get_channels(hw_params, &channels);
    printf("3. å£°é“æ•°: %uï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰\n", channels);
    unsigned int actual_rate;
    snd_pcm_hw_params_get_rate(hw_params, &actual_rate, 0);
    printf("4. é‡‡æ ·ç‡: %u Hz\n", actual_rate);
    snd_pcm_uframes_t actual_buffer_frames;
    snd_pcm_hw_params_get_buffer_size(hw_params, &actual_buffer_frames);
    printf("5. ç¼“å†²æ—¶é•¿: %.2f ms\n", (double)actual_buffer_frames / actual_rate * 1000);
    printf("=======================\n\n");

    // 4. åˆ†é…ç¼“å†²åŒº
    wav_buf = malloc(BUFFER_FRAMES * wav_frame_bytes);
    playback_buf = malloc(BUFFER_FRAMES * playback_frame_bytes);
    if (!wav_buf || !playback_buf) {
        fprintf(stderr, "å†…å­˜åˆ†é…å¤±è´¥\n");
        free(pfds);
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        free(wav_buf);
        free(playback_buf);
        return -1;
    }

    // 5. åˆå§‹åŒ–æ—¶é—´æ§åˆ¶
    int is_playing = 0;
    int first_print = 1;
    uint64_t play_start_ms = 0;
    uint64_t max_play_ms = (uint64_t)(wav_total_seconds * 1000);

    // 6. æ ¸å¿ƒæ’­æ”¾å¾ªç¯
    while (1) {
        // ç»ˆæ­¢æ¡ä»¶1ï¼šæ’­æ”¾æ—¶é•¿è¶…è¿‡WAVå®é™…æ—¶é•¿
        if (is_playing) {
            uint64_t current_ms = get_current_ms();
            uint64_t elapsed_ms = current_ms - play_start_ms;
            if (elapsed_ms >= max_play_ms) {
                printf("\nâ° è¾¾åˆ°WAVå®é™…æ—¶é•¿ï¼ˆ%.2fç§’ï¼‰ï¼Œåœæ­¢æ’­æ”¾\n", wav_total_seconds);
                break;
            }
            printf("ğŸ“ æ’­æ”¾è¿›åº¦: %.2f/%.2f ç§’ (%.1f%%) | çŠ¶æ€: è¿è¡Œä¸­\r",
                   (double)elapsed_ms / 1000, wav_total_seconds,
                   (double)elapsed_ms / max_play_ms * 100);
            fflush(stdout);
        }

        // ç»ˆæ­¢æ¡ä»¶2ï¼šå¸§æ•°å·²å†™å®Œ ä¸” ç¼“å†²åŒºä¸ºç©º
        if (frames_written >= total_frames) {
            snd_pcm_sframes_t delay_frames = snd_pcm_delay(pcm_handle, NULL);
            if (delay_frames <= 0) {
                printf("\nğŸ“ æ•°æ®å·²æ’­æ”¾å®Œæ¯•ï¼Œç¼“å†²åŒºæ— æ®‹ç•™\n");
                break;
            }
        }

        // è·å–å¯ç”¨å¸§æ•°
        snd_pcm_uframes_t avail_frames = snd_pcm_avail_update(pcm_handle);
        if (avail_frames <= 0) {
            if (avail_frames < 0) {
                ret = snd_pcm_recover(pcm_handle, avail_frames, 1);
                if (ret < 0) {
                    fprintf(stderr, "\nè®¾å¤‡æ¢å¤å¤±è´¥: %s\n", snd_strerror(ret));
                    break;
                }
            }

            // æ›¿æ¢usleepä¸ºpollï¼ˆäº‹ä»¶é©±åŠ¨ç­‰å¾…ï¼‰
            ret = poll(pfds, pcm_poll_fd_count, 10); // è¶…æ—¶10ms
            if (ret < 0) {
                fprintf(stderr, "pollå¤±è´¥: %m\n");
                break;
            } else if (ret == 0) {
                // è¶…æ—¶ï¼Œç»§ç»­å¾ªç¯
                continue;
            } else {
                // æœ‰äº‹ä»¶å‘ç”Ÿï¼Œè§£æäº‹ä»¶ç±»å‹
                unsigned short revents;
                ret = snd_pcm_poll_descriptors_revents(pcm_handle, pfds, pcm_poll_fd_count, &revents);
                if (ret < 0) {
                    fprintf(stderr, "è§£æpolläº‹ä»¶å¤±è´¥: %s\n", snd_strerror(ret));
                    break;
                }
                // æ£€æŸ¥æ˜¯å¦æ˜¯å¯å†™äº‹ä»¶ï¼Œéå¯å†™äº‹ä»¶åˆ™æ¢å¤è®¾å¤‡
                if (!(revents & POLLOUT)) {
                    snd_pcm_recover(pcm_handle, -EPIPE, 1);
                }
                printf("polläº‹ä»¶: revents=0x%04x time %lu\n", revents, get_current_ms());
            }
            continue;
        }

        // è®¡ç®—æœ¬æ¬¡å†™å…¥å¸§æ•°
        snd_pcm_uframes_t write_frames = avail_frames;
        if (write_frames > BUFFER_FRAMES) write_frames = BUFFER_FRAMES;
        if (frames_written + write_frames > total_frames) {
            write_frames = total_frames - frames_written;
        }

        if (write_frames > 0) {
            // è¯»å–WAVåŸå§‹æ•°æ®
            int read_frames = read_wav_audio(wav_buf, write_frames);
            if (read_frames <= 0) {
                write_frames = 0;
                continue;
            }

            // å£°é“è½¬æ¢
            if (wav_header.channels == 1) {
                mono_to_stereo((short*)wav_buf, (short*)playback_buf, read_frames);
            } else {
                memcpy(playback_buf, wav_buf, read_frames * playback_frame_bytes);
            }

            // MMAPå†™å…¥
            const snd_pcm_channel_area_t *areas;
            snd_pcm_uframes_t offset;
            ret = snd_pcm_mmap_begin(pcm_handle, &areas, &offset, &write_frames);
            
            if (ret >= 0 && write_frames > 0) {
                if (first_print) {
                    printf("\n===== MMAPç¼“å†²åŒºä¿¡æ¯ =====\n");
                    printf("åŸºåœ°å€: 0x%lx\n", (unsigned long)areas->addr);
                    first_print = 0;
                }

                char *dst = (char*)(areas->addr + offset * playback_frame_bytes);
                memcpy(dst, playback_buf, write_frames * playback_frame_bytes);
                
                ret = snd_pcm_mmap_commit(pcm_handle, offset, write_frames);
                if (ret > 0) {
                    frames_written += ret;

                    // å¯åŠ¨æ’­æ”¾å¹¶è®°å½•å¼€å§‹æ—¶é—´
                    if (!is_playing) {
                        ret = snd_pcm_start(pcm_handle);
                        if (ret < 0) {
                            fprintf(stderr, "å¯åŠ¨æ’­æ”¾å¤±è´¥: %s\n", snd_strerror(ret));
                        } else {
                            is_playing = 1;
                            play_start_ms = get_current_ms();
                            printf("âœ… æ’­æ”¾å¯åŠ¨ï¼Œå¼€å§‹è®¡æ—¶...\n");
                        }
                    }
                }
            }
        }
    }

    // 7. å¼ºåˆ¶åœæ­¢æ’­æ”¾
    if (is_playing) {
        snd_pcm_drop(pcm_handle);
        printf("âœ… å·²å¼ºåˆ¶åœæ­¢æ’­æ”¾ï¼Œç¼“å†²åŒºå·²æ¸…ç©º\n");
    }

    // 8. é‡Šæ”¾èµ„æº
    free(wav_buf);
    free(playback_buf);
    free(pfds); // é‡Šæ”¾pollç›¸å…³å†…å­˜
    snd_pcm_close(pcm_handle);
    fclose(wav_file);
    printf("\nğŸµ æ’­æ”¾å®Œæˆï¼å®é™…æ’­æ”¾æ—¶é•¿: %.2f ç§’\n", wav_total_seconds);
    return 0;
}

root@NYX-RK3568:/data# ./pcmmmap_file /usr/share/sounds/test.wav

===== WAVæ–‡ä»¶ä¿¡æ¯ =====
åŸå§‹å£°é“æ•°: 1
æ’­æ”¾å£°é“æ•°: 2ï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰
é‡‡æ ·ç‡: 16000 Hz
ä½æ·±: 16 bit
éŸ³é¢‘æ•°æ®å¤§å°: 46080 å­—èŠ‚
å®é™…æ—¶é•¿: 1.44 ç§’
========================


===== PCMç¡¬ä»¶å‚æ•° =====
1. è®¿é—®æ¨¡å¼: MMAP_INTERLEAVED
2. é‡‡æ ·æ ¼å¼: S16_LE
3. å£°é“æ•°: 2ï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰
4. é‡‡æ ·ç‡: 16000 Hz
5. ç¼“å†²æ—¶é•¿: 64.00 ms
=======================


===== MMAPç¼“å†²åŒºä¿¡æ¯ =====
åŸºåœ°å€: 0x7f89681000
âœ… æ’­æ”¾å¯åŠ¨ï¼Œå¼€å§‹è®¡æ—¶...
polläº‹ä»¶: revents=0x0004 time 5373932æ€: è¿è¡Œä¸­
polläº‹ä»¶: revents=0x0004 time 5373964æ€: è¿è¡Œä¸­
polläº‹ä»¶: revents=0x0004 time 5373996æ€: è¿è¡Œä¸­
polläº‹ä»¶: revents=0x0004 time 5374028æ€: è¿è¡Œä¸­
polläº‹ä»¶: revents=0x0004 time 5375212 æ€: è¿è¡Œä¸­
polläº‹ä»¶: revents=0x0004 time 5375244 æ€: è¿è¡Œä¸­
polläº‹ä»¶: revents=0x0004 time 5375277 æ€: è¿è¡Œä¸­
ğŸ“ æ’­æ”¾è¿›åº¦: 1.38/1.44 ç§’ (95.5%) | çŠ¶æ€: è¿è¡Œä¸­
ğŸ“ æ•°æ®å·²æ’­æ”¾å®Œæ¯•ï¼Œç¼“å†²åŒºæ— æ®‹ç•™
âœ… å·²å¼ºåˆ¶åœæ­¢æ’­æ”¾ï¼Œç¼“å†²åŒºå·²æ¸…ç©º

ğŸµ æ’­æ”¾å®Œæˆï¼å®é™…æ’­æ”¾æ—¶é•¿: 1.44 ç§’
