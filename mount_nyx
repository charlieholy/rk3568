root@NYX-RK3568:/data# mkdir -p /mnt/nyx_test
root@NYX-RK3568:/data# mount -t nyx2 none /mnt/nyx_test
mount: /mnt/nyx_test: unknown filesystem type 'nyx2'.
root@NYX-RK3568:/data# mount -t nyx none /mnt/nyx_test
root@NYX-RK3568:/data# mount
/dev/mmcblk0p6 on / type ext4 (rw,relatime)
devtmpfs on /dev type devtmpfs (rw,relatime,size=1899520k,nr_inodes=474880,mode=755)
proc on /proc type proc (rw,relatime)
devpts on /dev/pts type devpts (rw,relatime,gid=5,mode=620,ptmxmode=000)
tmpfs on /dev/shm type tmpfs (rw,relatime,mode=777)
tmpfs on /tmp type tmpfs (rw,relatime)
tmpfs on /run type tmpfs (rw,nosuid,nodev,relatime,mode=755)
sysfs on /sys type sysfs (rw,relatime)
debugfs on /sys/kernel/debug type debugfs (rw,relatime)
pstore on /sys/fs/pstore type pstore (rw,relatime)
/dev/mmcblk0p7 on /oem type ext2 (rw,relatime)
/dev/mmcblk0p8 on /userdata type ext2 (rw,relatime)
none on /sys/kernel/config type configfs (rw,relatime)
adb on /dev/usb-ffs/adb type functionfs (rw,relatime)
none on /mnt/nyx_test type nyx (rw,relatime)

/* mountNyx.c - 最终适配版：兼容只读 i_nlink 的 ARM64 内核 */
#include <linux/module.h>
#include <linux/fs.h>
#include <linux/mount.h>
#include <linux/pagemap.h>
#include <linux/init.h>
#include <linux/errno.h>
#include <linux/slab.h>
#include <linux/time.h>

// 定义 nyx 文件系统的超级块操作（通用实现）
static const struct super_operations nyx_super_ops = {
    .statfs = simple_statfs,    // 复用内核简单 statfs 实现
    .drop_inode = generic_delete_inode,
};

// 根目录的 inode 操作（极简）
static const struct inode_operations nyx_root_iops = {
    .lookup = simple_lookup,    // 通用目录查找接口
};

// 创建根目录的 inode（适配只读 i_nlink）
static struct inode *nyx_create_root_inode(struct super_block *sb) {
    struct inode *inode = new_inode(sb);
    if (!inode)
        return NULL;

    // 初始化根目录 inode 属性（仅用内核允许的方式操作）
    inode->i_ino = 1;                       // 根节点 inode 号固定为 1
    inode->i_mode = S_IFDIR | 0755;         // 目录类型 + 权限
    inode->i_atime = inode->i_mtime = inode->i_ctime = current_time(inode);
    inode->i_op = &nyx_root_iops;           // 关联 inode 操作
    inode->i_fop = &simple_dir_operations;  // 复用简单目录操作接口

    // 关键修复：用 set_nlink() 替代直接赋值 i_nlink
    set_nlink(inode, 2);                     // 目录默认 nlink 为 2（. 和 ..）
    return inode;
}

// 填充超级块（通用版）
static int nyx_fill_super(struct super_block *sb, void *data, int silent) {
    struct dentry *root_dentry;
    struct inode *root_inode;

    // 设置超级块属性
    sb->s_op = &nyx_super_ops;
    sb->s_flags |= SB_ACTIVE;

    // 创建根目录 inode
    root_inode = nyx_create_root_inode(sb);
    if (!root_inode)
        return -ENOMEM;

    // 创建根目录 dentry
    root_dentry = d_make_root(root_inode);
    if (!root_dentry) {
        iput(root_inode);
        return -ENOMEM;
    }

    sb->s_root = root_dentry;
    pr_info("nyx filesystem: super block initialized successfully\n");
    return 0;
}

// 挂载入口（使用通用的 mount_nodev）
static struct dentry *nyx_mount(struct file_system_type *fs_type,
                                int flags, const char *dev_name,
                                void *data) {
    return mount_nodev(fs_type, flags, data, nyx_fill_super);
}

// 定义 nyx 文件系统类型（关键：name = "nyx"）
static struct file_system_type nyx_fs_type = {
    .name = "nyx",          // mount 识别的类型名：-t nyx
    .mount = nyx_mount,     // 挂载回调函数
    .kill_sb = kill_litter_super, // 卸载回调（通用）
    .owner = THIS_MODULE,
};

// 模块初始化：注册 nyx 文件系统
static int __init nyx_fs_init(void) {
    int ret = register_filesystem(&nyx_fs_type);
    if (ret) {
        pr_err("nyx filesystem: failed to register, err=%d\n", ret);
        return ret;
    }
    pr_info("nyx filesystem: registered successfully\n");
    return 0;
}

// 模块退出：注销 nyx 文件系统
static void __exit nyx_fs_exit(void) {
    unregister_filesystem(&nyx_fs_type);
    pr_info("nyx filesystem: unregistered\n");
}

module_init(nyx_fs_init);
module_exit(nyx_fs_exit);

MODULE_LICENSE("GPL"); // 必须 GPL 协议，嵌入式内核强制要求
MODULE_DESCRIPTION("Custom nyx Filesystem (ARM64 Read-only i_nlink Compatible)");
MODULE_AUTHOR("Your Name");
