snd_pcm_sync_ptr  
  snd_pcm_hwsync

~/opt/linux_sdk/buildroot/output/rockchip_rk3568/host/bin/aarch64-buildroot-linux-gnu-gcc pcm_mmap.c -o pcm_mmap \
   -L ~/opt/linux_sdk//buildroot/output/rockchip_rk3568/host/aarch64-buildroot-linux-gnu/sysroot/usr/lib -lm -lasound \
   -I ~/opt/linux_sdk//buildroot/output/rockchip_rk3568/host/aarch64-buildroot-linux-gnu/sysroot/usr/include

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <unistd.h>
#include <alsa/asoundlib.h>

/************************ éŸ³é¢‘å‚æ•°é…ç½® ************************/
#define PCM_DEV         "hw:0,0"    // RK3568é»˜è®¤å£°å¡è®¾å¤‡
#define CHANNELS        2           // åŒå£°é“
#define PLAY_DURATION   1.0         // æ’­æ”¾æ—¶é•¿ï¼ˆç§’ï¼‰
#define MAX_AMPLITUDE   32767 / 2   // æœ€å¤§æŒ¯å¹…ï¼ˆé¿å…å¤±çœŸï¼‰
#define TARGET_FREQ     440.0       // æ­£å¼¦æ³¢é¢‘ç‡ï¼ˆA4éŸ³é«˜ï¼‰
/**************************************************************/
// å…¨å±€éŸ³é¢‘å‚æ•°ï¼ˆè§£å†³å®å–åœ°å€é—®é¢˜ï¼‰
unsigned int sample_rate = 44100;
// æ´¾ç”Ÿå‚æ•°ï¼ˆæ ¹æ®åŸºç¡€å‚æ•°è‡ªåŠ¨è®¡ç®—ï¼‰
#define FRAME_BYTES     (CHANNELS * 2)   // S16_LE: 2å­—èŠ‚/å£°é“
#define TOTAL_FRAMES    (int)(sample_rate * PLAY_DURATION)
#define TOTAL_BYTES     (TOTAL_FRAMES * FRAME_BYTES)

/**
 * @brief ç”ŸæˆæŒ‡å®šé¢‘ç‡çš„æ­£å¼¦æ³¢PCMæ•°æ®
 * @param pcm_buf è¾“å‡ºç¼“å†²åŒº
 * @param frames è¦ç”Ÿæˆçš„å¸§æ•°
 */
void generate_sine_wave(short *pcm_buf, int frames)
{
    double phase = 0.0;
    const double step = 2 * M_PI * TARGET_FREQ / sample_rate; // ç›¸ä½æ­¥é•¿

    for (int i = 0; i < frames * CHANNELS; i++) {
        pcm_buf[i] = (short)(MAX_AMPLITUDE * sin(phase));
        phase += step;
        // é‡ç½®ç›¸ä½é˜²æ­¢æº¢å‡º
        if (phase > 2 * M_PI) {
            phase -= 2 * M_PI;
        }
    }
}

/**
 * @brief åˆå§‹åŒ–PCMè®¾å¤‡å¹¶é…ç½®å‚æ•°
 * @param pcm_handle PCMè®¾å¤‡å¥æŸ„
 * @return 0æˆåŠŸï¼Œ-1å¤±è´¥
 */
int init_pcm_device(snd_pcm_t **pcm_handle)
{
    snd_pcm_hw_params_t *hw_params = NULL;
    snd_pcm_sw_params_t *sw_params = NULL;
    int ret = -1;

    // 1. æ‰“å¼€PCMæ’­æ”¾è®¾å¤‡ï¼ˆéé˜»å¡æ¨¡å¼ï¼Œé¿å…å¡æ­»ï¼‰
    ret = snd_pcm_open(pcm_handle, PCM_DEV, SND_PCM_STREAM_PLAYBACK, SND_PCM_NONBLOCK);
    if (ret < 0) {
        fprintf(stderr, "âŒ æ‰“å¼€PCMè®¾å¤‡å¤±è´¥: %s\n", snd_strerror(ret));
        return -1;
    }

    // 2. åˆ†é…ç¡¬ä»¶å‚æ•°ç»“æ„ä½“
    snd_pcm_hw_params_alloca(&hw_params);
    if (!hw_params) {
        fprintf(stderr, "âŒ åˆ†é…ç¡¬ä»¶å‚æ•°ç»“æ„ä½“å¤±è´¥\n");
        snd_pcm_close(*pcm_handle);
        *pcm_handle = NULL;
        return -1;
    }

    // 3. åˆå§‹åŒ–ç¡¬ä»¶å‚æ•°ä¸ºé»˜è®¤å€¼
    ret = snd_pcm_hw_params_any(*pcm_handle, hw_params);
    if (ret < 0) {
        fprintf(stderr, "âŒ åˆå§‹åŒ–ç¡¬ä»¶å‚æ•°å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(*pcm_handle);
        *pcm_handle = NULL;
        return -1;
    }

    // 4. é…ç½®æ ¸å¿ƒéŸ³é¢‘å‚æ•°
    // è®¾ç½®MMAPäº¤é”™æ¨¡å¼ï¼ˆé›¶æ‹·è´ï¼‰
    ret = snd_pcm_hw_params_set_access(*pcm_handle, hw_params, SND_PCM_ACCESS_MMAP_INTERLEAVED);
    // è®¾ç½®16ä½å°ç«¯æ ¼å¼
    ret |= snd_pcm_hw_params_set_format(*pcm_handle, hw_params, SND_PCM_FORMAT_S16_LE);
    // è®¾ç½®å£°é“æ•°
    ret |= snd_pcm_hw_params_set_channels(*pcm_handle, hw_params, CHANNELS);
    // è®¾ç½®é‡‡æ ·ç‡ï¼ˆè‡ªåŠ¨åŒ¹é…æœ€æ¥è¿‘çš„æ”¯æŒå€¼ï¼‰
    ret |= snd_pcm_hw_params_set_rate_near(*pcm_handle, hw_params, &sample_rate, 0);
    
    if (ret < 0) {
        fprintf(stderr, "âŒ é…ç½®éŸ³é¢‘å‚æ•°å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(*pcm_handle);
        *pcm_handle = NULL;
        return -1;
    }

    // 5. åº”ç”¨ç¡¬ä»¶å‚æ•°åˆ°è®¾å¤‡
    ret = snd_pcm_hw_params(*pcm_handle, hw_params);
    if (ret < 0) {
        fprintf(stderr, "âŒ åº”ç”¨ç¡¬ä»¶å‚æ•°å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(*pcm_handle);
        *pcm_handle = NULL;
        return -1;
    }

    // 6. é…ç½®è½¯ä»¶å‚æ•°ï¼ˆå…³é”®ï¼šè®¾ç½®è‡ªåŠ¨å¯åŠ¨æ’­æ”¾ï¼‰
    snd_pcm_sw_params_alloca(&sw_params);
    ret = snd_pcm_sw_params_current(*pcm_handle, sw_params);
    if (ret >= 0) {
        // è®¾ç½®ç¼“å­˜å¡«å……åˆ°æœ€å°é˜ˆå€¼æ—¶è‡ªåŠ¨å¯åŠ¨æ’­æ”¾
        snd_pcm_sw_params_set_start_threshold(*pcm_handle, sw_params, 1);
        ret = snd_pcm_sw_params(*pcm_handle, sw_params);
    }

    // 7. å‡†å¤‡PCMè®¾å¤‡
    ret = snd_pcm_prepare(*pcm_handle);
    if (ret < 0) {
        fprintf(stderr, "âŒ å‡†å¤‡PCMè®¾å¤‡å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(*pcm_handle);
        *pcm_handle = NULL;
        return -1;
    }

    // æ‰“å°æœ€ç»ˆé…ç½®
    printf("âœ… PCMè®¾å¤‡åˆå§‹åŒ–å®Œæˆ:\n");
    printf("   é‡‡æ ·ç‡: %dHz | å£°é“æ•°: %d | æ ¼å¼: S16_LE\n", sample_rate, CHANNELS);
    printf("   æ€»å¸§æ•°: %d | æ€»å­—èŠ‚æ•°: %d\n", TOTAL_FRAMES, TOTAL_BYTES);

    return 0;
}

/**
 * @brief MMAPæ¨¡å¼å†™å…¥PCMæ•°æ®åˆ°è®¾å¤‡
 * @param pcm_handle PCMè®¾å¤‡å¥æŸ„
 * @param audio_buf éŸ³é¢‘æ•°æ®ç¼“å†²åŒº
 * @return 0æˆåŠŸï¼Œ-1å¤±è´¥
 */
int write_pcm_data(snd_pcm_t *pcm_handle, short *audio_buf)
{
    snd_pcm_uframes_t frames_written = 0;

    while (frames_written < TOTAL_FRAMES) {
        // è·å–å¯ç”¨å†™å…¥å¸§æ•°
        snd_pcm_uframes_t avail_frames = snd_pcm_avail_update(pcm_handle);
        
        // å¤„ç†è®¾å¤‡é”™è¯¯æˆ–æ— å¯ç”¨ç©ºé—´
        if (avail_frames <= 0) {
            if (avail_frames < 0) {
                // å°è¯•æ¢å¤è®¾å¤‡
                snd_pcm_recover(pcm_handle, avail_frames, 1);
            }
            usleep(1000); // 1msåé‡è¯•
            continue;
        }

        // è®¡ç®—æœ¬æ¬¡å†™å…¥å¸§æ•°ï¼ˆä¸è¶…è¿‡å‰©ä½™å¸§æ•°ï¼‰
        snd_pcm_uframes_t write_frames = avail_frames;
        if (frames_written + write_frames > TOTAL_FRAMES) {
            write_frames = TOTAL_FRAMES - frames_written;
        }

        // MMAPæ–¹å¼å†™å…¥æ•°æ®
        const snd_pcm_channel_area_t *areas;
        snd_pcm_uframes_t offset;
        int ret = snd_pcm_mmap_begin(pcm_handle, &areas, &offset, &write_frames);
        
        if (ret >= 0 && write_frames > 0) {
            // è®¡ç®—ç›®æ ‡åœ°å€å¹¶æ‹·è´æ•°æ®
            short *dst = (short *)(areas->addr + offset * FRAME_BYTES);
            memcpy(dst, audio_buf + frames_written * CHANNELS, write_frames * FRAME_BYTES);
            // æäº¤å†™å…¥çš„æ•°æ®
            snd_pcm_mmap_commit(pcm_handle, offset, write_frames);
            frames_written += write_frames;
        }

        // æ‰“å°å†™å…¥è¿›åº¦
        printf("ğŸ“ å†™å…¥è¿›åº¦: %lu/%d å¸§ (%.1f%%)\r", 
               frames_written, TOTAL_FRAMES,
               (float)frames_written / TOTAL_FRAMES * 100);
        fflush(stdout);
    }

    // å…³é”®ä¿®å¤ï¼šæ˜¾å¼å¯åŠ¨æ’­æ”¾ï¼ˆRK3568å¿…é¡»ï¼‰
    int ret = snd_pcm_start(pcm_handle);
    if (ret < 0) {
        fprintf(stderr, "âš ï¸  æ˜¾å¼å¯åŠ¨æ’­æ”¾å¤±è´¥: %sï¼Œå°è¯•ç”¨writeiè§¦å‘\n", snd_strerror(ret));
        // å¤‡ç”¨æ–¹æ¡ˆï¼šç”¨ç©ºçš„writeiè§¦å‘æ’­æ”¾
        short dummy[2] = {0};
        snd_pcm_writei(pcm_handle, dummy, 1);
    } else {
        printf("\nâœ… æ˜¾å¼å¯åŠ¨PCMæ’­æ”¾æˆåŠŸ\n");
    }

    printf("\nâœ… æ‰€æœ‰éŸ³é¢‘æ•°æ®å†™å…¥å®Œæˆ\n");
    return 0;
}

/**
 * @brief ç²¾å‡†ç­‰å¾…éŸ³é¢‘æ’­æ”¾å®Œæˆï¼ˆæ›¿ä»£snd_pcm_sync_ptrï¼‰
 * @param pcm_handle PCMè®¾å¤‡å¥æŸ„
 * @param total_written æ€»å†™å…¥å¸§æ•°
 */
void wait_playback_complete(snd_pcm_t *pcm_handle, snd_pcm_uframes_t total_written)
{
    printf("ğŸ“¢ ç­‰å¾…éŸ³é¢‘æ’­æ”¾å®Œæˆï¼ˆç²¾å‡†åŒæ­¥ï¼‰...\n");
    snd_pcm_sframes_t delay_frames;
    snd_pcm_uframes_t total_played = 0;
    int timeout = 0;
    const int MAX_TIMEOUT = 5000; // æœ€å¤§ç­‰å¾…5ç§’

    while (total_played < total_written && timeout < MAX_TIMEOUT) {
        // è·å–å»¶è¿Ÿå¸§æ•°ï¼ˆç¡¬ä»¶æœªæ’­æ”¾çš„å¸§æ•°ï¼‰
        int ret = snd_pcm_delay(pcm_handle, &delay_frames);
        if (ret < 0) {
            fprintf(stderr, "âš ï¸  è·å–å»¶è¿Ÿå¸§æ•°å¤±è´¥: %sï¼Œæ”¹ç”¨drainç­‰å¾…\n", snd_strerror(ret));
            snd_pcm_drain(pcm_handle);
            break;
        }

        // è®¡ç®—å·²æ’­æ”¾å¸§æ•°ï¼ˆæ€»å†™å…¥ - å»¶è¿Ÿå¸§æ•°ï¼‰
        total_played = total_written - delay_frames;
        if (total_played < 0) {
            total_played = 0;
        }

        // æ‰“å°æ’­æ”¾è¿›åº¦
        printf("ğŸµ æ’­æ”¾è¿›åº¦: %lu/%d å¸§ (%.1f%%)\r", 
               total_played, TOTAL_FRAMES,
               (float)total_played / TOTAL_FRAMES * 100);
        fflush(stdout);

        usleep(1000); // 1msè½®è¯¢ä¸€æ¬¡
        timeout++;
    }

    // å¼ºåˆ¶æ’ç©ºç¼“å­˜ï¼ˆç¡®ä¿æ‰€æœ‰æ•°æ®æ’­æ”¾å®Œæ¯•ï¼‰
    snd_pcm_drain(pcm_handle);
    
    if (total_played >= total_written) {
        printf("\nğŸ‰ 1ç§’440Hzæ­£å¼¦æ³¢éŸ³é¢‘æ’­æ”¾å®Œæˆï¼\n");
    } else {
        printf("\nâš ï¸  æ’­æ”¾è¶…æ—¶ï¼Œä½†å·²å¼ºåˆ¶æ’ç©ºç¼“å­˜ï¼ˆéŸ³é¢‘å·²æ’­æ”¾ï¼‰\n");
    }
}

int main()
{
    snd_pcm_t *pcm_handle = NULL;
    short *audio_buf = NULL;
    int ret = -1;

    // 1. åˆå§‹åŒ–PCMè®¾å¤‡
    if (init_pcm_device(&pcm_handle) != 0) {
        goto cleanup;
    }

    // 2. åˆ†é…éŸ³é¢‘ç¼“å†²åŒº
    audio_buf = (short *)malloc(TOTAL_BYTES);
    if (!audio_buf) {
        fprintf(stderr, "âŒ åˆ†é…éŸ³é¢‘ç¼“å†²åŒºå¤±è´¥\n");
        goto cleanup;
    }

    // 3. ç”Ÿæˆæ­£å¼¦æ³¢æ•°æ®
    generate_sine_wave(audio_buf, TOTAL_FRAMES);
    printf("âœ… ç”Ÿæˆ1ç§’440Hzæ­£å¼¦æ³¢æ•°æ®å®Œæˆ\n");

    // 4. å†™å…¥PCMæ•°æ®
    if (write_pcm_data(pcm_handle, audio_buf) != 0) {
        goto cleanup;
    }

    // 5. ç­‰å¾…æ’­æ”¾å®Œæˆ
    wait_playback_complete(pcm_handle, TOTAL_FRAMES);

    ret = 0;

// èµ„æºæ¸…ç†
cleanup:
    if (audio_buf) {
        free(audio_buf);
        audio_buf = NULL;
    }
    if (pcm_handle) {
        snd_pcm_close(pcm_handle);
        pcm_handle = NULL;
    }

    return ret;
}
