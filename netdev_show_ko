#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/netdevice.h>
#include <linux/list.h>
#include <linux/rculist.h>
#include <linux/net_namespace.h>

// 驱动核心：遍历 init_net 下所有网卡并打印名称
static void scan_all_netdev_names(void)
{
    struct net_device *dev;

    // RCU 读锁保护：防止遍历过程中网卡被动态增删
    rcu_read_lock();
    // 遍历 init_net（默认命名空间）下的所有网卡
    for_each_netdev(&init_net, dev) {
        // 仅打印网卡名称（避免 nd_net 类型问题）
        pr_info("NetDevice Name: %s\n", dev->name);
    }
    rcu_read_unlock();

    // 【可选】手动遍历链表（备用方案，兼容所有内核版本）
    /*
    struct list_head *pos;
    rcu_read_lock();
    list_for_each_rcu(pos, &dev_base_head) {
        dev = list_entry(pos, struct net_device, dev_list);
        // 筛选归属 init_net 的网卡（绕过 possible_net_t 封装）
        if (dev_net(dev) == &init_net) {
            pr_info("NetDevice Name(manual): %s\n", dev->name);
        }
    }
    rcu_read_unlock();
    */
}

// 驱动初始化函数
static int __init netdev_scan_init(void)
{
    pr_info("==== Start scanning net devices in init_net ====\n");
    scan_all_netdev_names();
    pr_info("==== Net device scan completed ====\n");
    return 0;
}

// 驱动卸载函数
static void __exit netdev_scan_exit(void)
{
    pr_info("Net device scan driver unloaded\n");
}

// 内核模块入口/出口
module_init(netdev_scan_init);
module_exit(netdev_scan_exit);

// 必须声明 GPL 许可证（内核驱动强制要求）
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Custom");
MODULE_DESCRIPTION("Scan all net device names in init_net (ARM64)");
MODULE_VERSION("1.0");

//////////////////
[ 5433.470767] ==== Start scanning net devices in init_net ====
[ 5433.470786] NetDevice Name: lo
[ 5433.470798] NetDevice Name: can0
[ 5433.470809] NetDevice Name: eth0
[ 5433.470821] NetDevice Name: eth1
[ 5433.470830] NetDevice Name: wlan0
[ 5433.470840] ==== Net device scan completed ====

