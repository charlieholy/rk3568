#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/netdevice.h>
#include <linux/list.h>
#include <linux/rculist.h>
#include <linux/net_namespace.h>

// 驱动核心：遍历 init_net 下所有网卡并打印名称
static void scan_all_netdev_names(void)
{
    struct net_device *dev;

    // RCU 读锁保护：防止遍历过程中网卡被动态增删
    rcu_read_lock();
    // 遍历 init_net（默认命名空间）下的所有网卡
    for_each_netdev(&init_net, dev) {
        // 仅打印网卡名称（避免 nd_net 类型问题）
        pr_info("NetDevice Name: %s\n", dev->name);
    }
    rcu_read_unlock();

    // 【可选】手动遍历链表（备用方案，兼容所有内核版本）
    /*
    struct list_head *pos;
    rcu_read_lock();
    list_for_each_rcu(pos, &dev_base_head) {
        dev = list_entry(pos, struct net_device, dev_list);
        // 筛选归属 init_net 的网卡（绕过 possible_net_t 封装）
        if (dev_net(dev) == &init_net) {
            pr_info("NetDevice Name(manual): %s\n", dev->name);
        }
    }
    rcu_read_unlock();
    */
}

// 驱动初始化函数
static int __init netdev_scan_init(void)
{
    pr_info("==== Start scanning net devices in init_net ====\n");
    scan_all_netdev_names();
    pr_info("==== Net device scan completed ====\n");
    return 0;
}

// 驱动卸载函数
static void __exit netdev_scan_exit(void)
{
    pr_info("Net device scan driver unloaded\n");
}

// 内核模块入口/出口
module_init(netdev_scan_init);
module_exit(netdev_scan_exit);

// 必须声明 GPL 许可证（内核驱动强制要求）
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Custom");
MODULE_DESCRIPTION("Scan all net device names in init_net (ARM64)");
MODULE_VERSION("1.0");

//////////////////
[ 5433.470767] ==== Start scanning net devices in init_net ====
[ 5433.470786] NetDevice Name: lo
[ 5433.470798] NetDevice Name: can0
[ 5433.470809] NetDevice Name: eth0
[ 5433.470821] NetDevice Name: eth1
[ 5433.470830] NetDevice Name: wlan0
[ 5433.470840] ==== Net device scan completed ====

///////////////////
(gdb) p &(*(struct net_device*)0)->dev_list
$5 = (struct list_head *) 0x50

(gdb) p ((struct net_device*)0xffffffc0e8d19000)->name
$7 = "lo", '\000' <repeats 13 times>
(gdb) p init_net->dev_base_head->next->next
$8 = (struct list_head *) 0xffffffc0e8d1a050
(gdb) p ((struct net_device*)0xffffffc0e8d1a000)->name
$9 = "can0", '\000' <repeats 11 times>
(gdb) p init_net->dev_base_head->next->next->next
$10 = (struct list_head *) 0xffffffc0e7afc050
(gdb) p ((struct net_device*)0xffffffc0e7afc000)->name
$11 = "eth0", '\000' <repeats 11 times>
(gdb) p init_net->dev_base_head->next->next->next->next
$12 = (struct list_head *) 0xffffffc0e7b7c050
(gdb) p ((struct net_device*)0xffffffc0e7b7c000)->name
$13 = "eth1", '\000' <repeats 11 times>
(gdb) p init_net->dev_base_head->next->next->next->next->next
$14 = (struct list_head *) 0xffffffc0e3525050
(gdb) p ((struct net_device*)0xffffffc0e3525000)->name
$15 = "wlan0\000\000\000\000\000\000\000\000\000\000"
(gdb) p init_net->dev_base_head->next->next->next->next->next->
A syntax error in expression, near `'.
(gdb) p init_net->dev_base_head->next->next->next->next->next->next
$16 = (struct list_head *) 0xffffff80095c4250 <init_net+336>
(gdb) p ((struct net_device*)0xffffff80095c4200)->name
$17 = "\030hK\t\200\377\377\377\250\310^\t\200\377\377\377"

