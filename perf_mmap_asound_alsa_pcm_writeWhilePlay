./perf record -g  ./pcm_mmap
./perf report -n --stdio > pcm_mmap.txt

// ~/opt/linux_sdk/buildroot/output/rockchip_rk3568/host/bin/aarch64-buildroot-linux-gnu-gcc pcm_mmap.c -o pcm_mmap \
//   -L ~/opt/linux_sdk//buildroot/output/rockchip_rk3568/host/aarch64-buildroot-linux-gnu/sysroot/usr/lib -lm -lasound \
//   -I ~/opt/linux_sdk//buildroot/output/rockchip_rk3568/host/aarch64-buildroot-linux-gnu/sysroot/usr/include 

#include <alsa/asoundlib.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// é…ç½®å‚æ•°ï¼ˆæ ¹æ®ä½ çš„å®é™…åœºæ™¯è°ƒæ•´ï¼‰
#define PCM_DEVICE "hw:0,0"
#define CHANNELS 2                // å£°é“æ•°
#define SAMPLE_RATE 44100         // é‡‡æ ·ç‡
#define FORMAT SND_PCM_FORMAT_S16_LE // é‡‡æ ·æ ¼å¼
#define FRAME_BYTES (CHANNELS * snd_pcm_format_width(FORMAT) / 8) // æ¯å¸§å­—èŠ‚æ•°
#define TOTAL_FRAMES (SAMPLE_RATE * 5) // æ€»æ’­æ”¾æ—¶é•¿5ç§’
#define BUFFER_FRAMES 1024        // æ¯æ¬¡å†™å…¥çš„æœ€å°å¸§æ•°

// ç”Ÿæˆå®æ—¶æµ‹è¯•æ•°æ®ï¼ˆæ¨¡æ‹ŸåŠ¨æ€éŸ³é¢‘æºï¼‰
void generate_realtime_audio(short *buf, snd_pcm_uframes_t frames, int channels, int sample_rate) {
    static double phase = 0.0;
    double step = 2 * 3.1415926 * 440.0 / sample_rate; // 440Hzæ­£å¼¦æ³¢
    for (snd_pcm_uframes_t i = 0; i < frames; i++) {
        short val = (short)(32767 * sin(phase));
        buf[i * channels] = val;     // å·¦å£°é“
        buf[i * channels + 1] = val; // å³å£°é“
        phase += step;
        if (phase > 2 * 3.1415926) phase -= 2 * 3.1415926;
    }
}

int main() {
    snd_pcm_t *pcm_handle = NULL;
    short *audio_buf = NULL;
    snd_pcm_uframes_t frames_written = 0;
    int ret;

    // 1. æ‰“å¼€PCMè®¾å¤‡ï¼ˆMMAPæ¨¡å¼ï¼‰
    ret = snd_pcm_open(&pcm_handle, PCM_DEVICE, SND_PCM_STREAM_PLAYBACK, SND_PCM_NONBLOCK);
    if (ret < 0) {
        fprintf(stderr, "æ‰“å¼€è®¾å¤‡å¤±è´¥: %s\n", snd_strerror(ret));
        return -1;
    }

    // 2. é…ç½®PCMå‚æ•°ï¼ˆå¿…é¡»å¯ç”¨MMAPè®¿é—®æ¨¡å¼ï¼‰
    snd_pcm_hw_params_t *hw_params;
    snd_pcm_hw_params_alloca(&hw_params);
    snd_pcm_hw_params_any(pcm_handle, hw_params);
    
    // å…³é”®ï¼šè®¾ç½®MMAPè®¿é—®æ¨¡å¼ï¼ˆæµå¼ä¼ è¾“çš„æ ¸å¿ƒï¼‰
    ret = snd_pcm_hw_params_set_access(pcm_handle, hw_params, SND_PCM_ACCESS_MMAP_INTERLEAVED);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®MMAPæ¨¡å¼å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(pcm_handle);
        return -1;
    }

    // è®¾ç½®å…¶ä»–å‚æ•°
    snd_pcm_hw_params_set_format(pcm_handle, hw_params, FORMAT);
    snd_pcm_hw_params_set_channels(pcm_handle, hw_params, CHANNELS);
    unsigned int rate = SAMPLE_RATE;
    snd_pcm_hw_params_set_rate_near(pcm_handle, hw_params, &rate, 0);
    
    // è®¾ç½®ç¼“å†²åŒºå’Œå‘¨æœŸå¤§å°ï¼ˆå½±å“å®æ—¶æ€§ï¼‰
    snd_pcm_uframes_t period_frames = BUFFER_FRAMES;
    snd_pcm_hw_params_set_period_size_near(pcm_handle, hw_params, &period_frames, 0);
    snd_pcm_uframes_t buffer_frames = period_frames * 4;
    snd_pcm_hw_params_set_buffer_size_near(pcm_handle, hw_params, &buffer_frames);

    // åº”ç”¨å‚æ•°
    ret = snd_pcm_hw_params(pcm_handle, hw_params);
    if (ret < 0) {
        fprintf(stderr, "åº”ç”¨å‚æ•°å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(pcm_handle);
        return -1;
    }

    // 3. åˆ†é…ä¸´æ—¶éŸ³é¢‘ç¼“å†²åŒºï¼ˆæ¨¡æ‹Ÿå®æ—¶æ•°æ®æ¥æºï¼‰
    audio_buf = (short *)malloc(BUFFER_FRAMES * CHANNELS * sizeof(short));
    if (!audio_buf) {
        fprintf(stderr, "å†…å­˜åˆ†é…å¤±è´¥\n");
        snd_pcm_close(pcm_handle);
        return -1;
    }

    // æ ‡è®°ï¼šæ˜¯å¦å·²å¯åŠ¨æ’­æ”¾
    int is_playing = 0;

    // 4. è¾¹å†™è¾¹æ’­çš„æ ¸å¿ƒå¾ªç¯
    while (frames_written < TOTAL_FRAMES) {
        // è·å–å¯ç”¨å†™å…¥å¸§æ•°ï¼ˆMMAPç¼“å†²åŒºçš„ç©ºé—²ç©ºé—´ï¼‰
        snd_pcm_uframes_t avail_frames = snd_pcm_avail_update(pcm_handle);
        
        // å¤„ç†è®¾å¤‡é”™è¯¯æˆ–æ— å¯ç”¨ç©ºé—´
        if (avail_frames <= 0) {
            if (avail_frames < 0) {
                ret = snd_pcm_recover(pcm_handle, avail_frames, 1);
                if (ret < 0) {
                    fprintf(stderr, "è®¾å¤‡æ¢å¤å¤±è´¥: %s\n", snd_strerror(ret));
                    break;
                }
            }
            usleep(1000); // 1msåé‡è¯•ï¼Œé™ä½CPUå ç”¨
            continue;
        }

        // è®¡ç®—æœ¬æ¬¡å†™å…¥å¸§æ•°ï¼ˆä¸è¶…è¿‡å‰©ä½™å¸§æ•°ï¼Œä¸”ä¸å°äºæœ€å°ç¼“å†²åŒºï¼‰
        snd_pcm_uframes_t write_frames = avail_frames;
        if (write_frames > BUFFER_FRAMES) write_frames = BUFFER_FRAMES; // æ¯æ¬¡å†™å›ºå®šå¤§å°ï¼Œæ›´å®æ—¶
        if (frames_written + write_frames > TOTAL_FRAMES) {
            write_frames = TOTAL_FRAMES - frames_written;
        }

        if (write_frames > 0) {
            // ç”Ÿæˆå®æ—¶éŸ³é¢‘æ•°æ®ï¼ˆæ¨¡æ‹ŸåŠ¨æ€è¾“å…¥ï¼Œæ¯”å¦‚éº¦å…‹é£ã€ç½‘ç»œæµç­‰ï¼‰
            generate_realtime_audio(audio_buf, write_frames, CHANNELS, SAMPLE_RATE);

            // MMAPæ–¹å¼å†™å…¥æ•°æ®
            const snd_pcm_channel_area_t *areas;
            snd_pcm_uframes_t offset;
            ret = snd_pcm_mmap_begin(pcm_handle, &areas, &offset, &write_frames);
            
            if (ret >= 0 && write_frames > 0) {
                // æ‹·è´å®æ—¶ç”Ÿæˆçš„æ•°æ®åˆ°MMAPç¼“å†²åŒº
                short *dst = (short *)(areas->addr + offset * FRAME_BYTES);
                memcpy(dst, audio_buf, write_frames * FRAME_BYTES);
                
                // æäº¤å†™å…¥çš„æ•°æ®ï¼ˆç¡¬ä»¶å¯è§ï¼‰
                ret = snd_pcm_mmap_commit(pcm_handle, offset, write_frames);
                if (ret > 0) {
                    frames_written += ret;

                    // å…³é”®ï¼šé¦–æ¬¡å†™å…¥æ•°æ®åï¼Œç«‹å³å¯åŠ¨æ’­æ”¾ï¼ˆåªå¯åŠ¨ä¸€æ¬¡ï¼‰
                    if (!is_playing) {
                        ret = snd_pcm_start(pcm_handle); // RK3568å¿…é¡»æ˜¾å¼è°ƒç”¨
                        if (ret < 0) {
                            fprintf(stderr, "å¯åŠ¨æ’­æ”¾å¤±è´¥: %s\n", snd_strerror(ret));
                        } else {
                            is_playing = 1;
                            printf("âœ… æ’­æ”¾å·²å¯åŠ¨ï¼Œå¼€å§‹å®æ—¶å†™å…¥...\n");
                        }
                    }
                }
            }
        }

        // æ‰“å°å®æ—¶è¿›åº¦
        printf("ğŸ“ å®æ—¶å†™å…¥è¿›åº¦: %lu/%d å¸§ (%.1f%%) | æ’­æ”¾çŠ¶æ€: %s\r", 
               frames_written, TOTAL_FRAMES,
               (float)frames_written / TOTAL_FRAMES * 100,
               is_playing ? "è¿è¡Œä¸­" : "æœªå¯åŠ¨");
        fflush(stdout);
    }

    // 5. ç­‰å¾…ç¼“å†²åŒºå‰©ä½™æ•°æ®æ’­æ”¾å®Œæ¯•
    if (is_playing) {
        printf("\nâ³ ç­‰å¾…å‰©ä½™éŸ³é¢‘æ’­æ”¾å®Œæ¯•...\n");
        snd_pcm_drain(pcm_handle); // é˜»å¡ç›´åˆ°ç¼“å†²åŒºç©º
    }

    // 6. é‡Šæ”¾èµ„æº
    free(audio_buf);
    snd_pcm_close(pcm_handle);
    printf("âœ… æ’­æ”¾å®Œæˆï¼\n");
    return 0;
}
