#include <alsa/asoundlib.h>
#include <math.h> 
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <time.h>  // æ–°å¢ï¼šæ—¶é—´æ§åˆ¶å¤´æ–‡ä»¶

// WAVæ–‡ä»¶å¤´ç»“æ„ä½“
typedef struct {
    char        riff_id[4];        
    uint32_t    riff_size;         
    char        riff_type[4];      
    char        fmt_id[4];         
    uint32_t    fmt_size;          
    uint16_t    audio_format;      
    uint16_t    channels;          
    uint32_t    sample_rate;       
    uint32_t    byte_rate;         
    uint16_t    block_align;       
    uint16_t    bits_per_sample;   
    char        data_id[4];        
    uint32_t    data_size;         
} WavHeader;

// å…¨å±€å˜é‡
FILE *wav_file = NULL;
WavHeader wav_header;
snd_pcm_format_t wav_format;
int wav_frame_bytes;          // WAVæ–‡ä»¶åŸå§‹æ¯å¸§å­—èŠ‚æ•°
int playback_frame_bytes;     // æ’­æ”¾æ—¶ï¼ˆåŒå£°é“ï¼‰æ¯å¸§å­—èŠ‚æ•°
// æ–°å¢ï¼šWAVå®é™…æ—¶é•¿ï¼ˆç§’ï¼‰
double wav_total_seconds;

// ä»WAVæ–‡ä»¶è¯»å–åŸå§‹éŸ³é¢‘æ•°æ®
int read_wav_audio(void *buf, snd_pcm_uframes_t frames) {
    if (!wav_file || feof(wav_file)) {
        return 0;
    }
    size_t read_bytes = frames * wav_frame_bytes;
    size_t ret = fread(buf, 1, read_bytes, wav_file);
    if (ret < read_bytes) {
        memset((char*)buf + ret, 0, read_bytes - ret);
    }
    return ret / wav_frame_bytes;
}

// æ–°å¢ï¼šå•å£°é“è½¬åŒå£°é“ï¼ˆæ ¸å¿ƒï¼‰
void mono_to_stereo(short *mono_buf, short *stereo_buf, snd_pcm_uframes_t frames) {
    for (snd_pcm_uframes_t i = 0; i < frames; i++) {
        stereo_buf[i * 2] = mono_buf[i];    // å·¦å£°é“
        stereo_buf[i * 2 + 1] = mono_buf[i];// å³å£°é“ï¼ˆå¤åˆ¶å•å£°é“æ•°æ®ï¼‰
    }
}

// è§£æWAVå¤´ï¼ˆæ–°å¢ï¼šè®¡ç®—å®é™…æ—¶é•¿ + åŒºåˆ†åŸå§‹/æ’­æ”¾å¸§å­—èŠ‚æ•°ï¼‰
int parse_wav_header(const char *wav_path) {
    wav_file = fopen(wav_path, "rb");
    if (!wav_file) {
        fprintf(stderr, "æ‰“å¼€WAVæ–‡ä»¶å¤±è´¥: %s\n", wav_path);
        return -1;
    }

    size_t ret = fread(&wav_header, 1, sizeof(WavHeader), wav_file);
    if (ret != sizeof(WavHeader)) {
        fprintf(stderr, "è¯»å–WAVå¤´å¤±è´¥\n");
        fclose(wav_file);
        return -1;
    }

    // éªŒè¯æ ¼å¼
    if (memcmp(wav_header.riff_id, "RIFF", 4) != 0 ||
        memcmp(wav_header.riff_type, "WAVE", 4) != 0 ||
        memcmp(wav_header.fmt_id, "fmt ", 4) != 0 ||
        memcmp(wav_header.data_id, "data", 4) != 0) {
        fprintf(stderr, "ä¸æ˜¯æ ‡å‡†WAVæ–‡ä»¶\n");
        fclose(wav_file);
        return -1;
    }
    if (wav_header.audio_format != 1) {
        fprintf(stderr, "ä»…æ”¯æŒPCMéå‹ç¼©æ ¼å¼\n");
        fclose(wav_file);
        return -1;
    }
    if (wav_header.bits_per_sample != 16) {
        fprintf(stderr, "ä»…æ”¯æŒ16ä½WAV\n");
        fclose(wav_file);
        return -1;
    }

    // åˆå§‹åŒ–å‚æ•°
    wav_format = SND_PCM_FORMAT_S16_LE;
    // WAVåŸå§‹å¸§å­—èŠ‚æ•°ï¼ˆå•å£°é“=2ï¼ŒåŒå£°é“=4ï¼‰
    wav_frame_bytes = wav_header.channels * (wav_header.bits_per_sample / 8);
    // æ’­æ”¾æ—¶å¼ºåˆ¶åŒå£°é“ï¼Œå¸§å­—èŠ‚æ•°å›ºå®šä¸º4ï¼ˆ2å£°é“Ã—16ä½/8ï¼‰
    playback_frame_bytes = 2 * (wav_header.bits_per_sample / 8);
    // æ ¸å¿ƒï¼šè®¡ç®—WAVå®é™…æ—¶é•¿ = æ•°æ®æ€»å­—èŠ‚æ•° / å­—èŠ‚ç‡
    wav_total_seconds = (double)wav_header.data_size / wav_header.byte_rate;

    // æ‰“å°ä¿¡æ¯ï¼ˆæ–°å¢å£°é“è½¬æ¢æç¤ºï¼‰
    printf("\n===== WAVæ–‡ä»¶ä¿¡æ¯ =====\n");
    printf("åŸå§‹å£°é“æ•°: %d\n", wav_header.channels);
    printf("æ’­æ”¾å£°é“æ•°: 2ï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰\n");
    printf("é‡‡æ ·ç‡: %d Hz\n", wav_header.sample_rate);
    printf("ä½æ·±: %d bit\n", wav_header.bits_per_sample);
    printf("éŸ³é¢‘æ•°æ®å¤§å°: %d å­—èŠ‚\n", wav_header.data_size);
    printf("å®é™…æ—¶é•¿: %.2f ç§’\n", wav_total_seconds);
    printf("========================\n\n");

    return 0;
}

#define PCM_DEVICE "hw:1,0"  // ä¿®æ­£ä¸ºå®é™…è®¾å¤‡
#define BUFFER_FRAMES 1024

// æ–°å¢ï¼šè·å–å½“å‰æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
uint64_t get_current_ms() {
    struct timespec ts;
    clock_gettime(CLOCK_MONOTONIC, &ts);
    return (uint64_t)ts.tv_sec * 1000 + ts.tv_nsec / 1000000;
}

int main(int argc, char *argv[]) {
    if (argc != 2) {
        fprintf(stderr, "ç”¨æ³•: %s <WAVæ–‡ä»¶è·¯å¾„>\n", argv[0]);
        return -1;
    }

    snd_pcm_t *pcm_handle = NULL;
    void *wav_buf = NULL;       // å­˜å‚¨WAVåŸå§‹æ•°æ®ï¼ˆå•/åŒå£°é“ï¼‰
    void *playback_buf = NULL;  // å­˜å‚¨æ’­æ”¾ç”¨æ•°æ®ï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰
    snd_pcm_uframes_t frames_written = 0;
    int ret;

    // 1. è§£æWAV
    if (parse_wav_header(argv[1]) < 0) {
        return -1;
    }
    // æ€»å¸§æ•°æŒ‰WAVåŸå§‹æ ¼å¼è®¡ç®—
    snd_pcm_uframes_t total_frames = wav_header.data_size / wav_frame_bytes;

    // 2. æ‰“å¼€PCMè®¾å¤‡ï¼ˆæ”¹ä¸ºé˜»å¡æ¨¡å¼ï¼Œæ›´ç¨³å®šï¼‰
    ret = snd_pcm_open(&pcm_handle, PCM_DEVICE, SND_PCM_STREAM_PLAYBACK, 0);
    if (ret < 0) {
        fprintf(stderr, "æ‰“å¼€è®¾å¤‡å¤±è´¥: %s\n", snd_strerror(ret));
        fclose(wav_file);
        return -1;
    }

    // 3. é…ç½®PCMå‚æ•°ï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰
    snd_pcm_hw_params_t *hw_params;
    snd_pcm_hw_params_alloca(&hw_params);
    snd_pcm_hw_params_any(pcm_handle, hw_params);
    
    ret = snd_pcm_hw_params_set_access(pcm_handle, hw_params, SND_PCM_ACCESS_MMAP_INTERLEAVED);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®MMAPæ¨¡å¼å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    ret = snd_pcm_hw_params_set_format(pcm_handle, hw_params, wav_format);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®æ ¼å¼å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    // æ ¸å¿ƒä¿®æ”¹ï¼šå¼ºåˆ¶è®¾ç½®ä¸º2å£°é“ï¼ˆä¸ç®¡WAVæ˜¯å•/åŒå£°é“ï¼‰
    ret = snd_pcm_hw_params_set_channels(pcm_handle, hw_params, 2);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®åŒå£°é“å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    unsigned int rate = wav_header.sample_rate;
    ret = snd_pcm_hw_params_set_rate_near(pcm_handle, hw_params, &rate, 0);
    if (ret < 0) {
        fprintf(stderr, "è®¾ç½®é‡‡æ ·ç‡å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }
    if (rate != wav_header.sample_rate) {
        printf("è­¦å‘Šï¼šé‡‡æ ·ç‡ä¸åŒ¹é…ï¼Œä½¿ç”¨ %d Hz æ›¿ä»£ %d Hz\n", rate, wav_header.sample_rate);
    }
    
    // ä¼˜åŒ–ç¼“å†²åŒºå¤§å°ï¼ˆå‡å°‘å»¶è¿Ÿï¼Œæå‡æ—¶é—´ç²¾åº¦ï¼‰
    snd_pcm_uframes_t period_frames = 512;  // ç¼©å°å‘¨æœŸå¸§ï¼Œæ›´ç²¾å‡†
    snd_pcm_hw_params_set_period_size_near(pcm_handle, hw_params, &period_frames, 0);
    snd_pcm_uframes_t buffer_frames = period_frames * 2;  // ç¼“å†²åŒº=2ä¸ªå‘¨æœŸ
    snd_pcm_hw_params_set_buffer_size_near(pcm_handle, hw_params, &buffer_frames);

    ret = snd_pcm_hw_params(pcm_handle, hw_params);
    if (ret < 0) {
        fprintf(stderr, "åº”ç”¨å‚æ•°å¤±è´¥: %s\n", snd_strerror(ret));
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        return -1;
    }

    // æ‰“å°PCMå‚æ•°ï¼ˆç¡®è®¤åŒå£°é“ï¼‰
    printf("\n===== PCMç¡¬ä»¶å‚æ•° =====\n");
    snd_pcm_access_t access;
    snd_pcm_hw_params_get_access(hw_params, &access);
    printf("1. è®¿é—®æ¨¡å¼: %s\n", access == SND_PCM_ACCESS_MMAP_INTERLEAVED ? "MMAP_INTERLEAVED" : "å…¶ä»–");
    snd_pcm_format_t format;
    snd_pcm_hw_params_get_format(hw_params, &format);
    printf("2. é‡‡æ ·æ ¼å¼: %s\n", snd_pcm_format_name(format));
    unsigned int channels;
    snd_pcm_hw_params_get_channels(hw_params, &channels);
    printf("3. å£°é“æ•°: %uï¼ˆå¼ºåˆ¶åŒå£°é“ï¼‰\n", channels);
    unsigned int actual_rate;
    snd_pcm_hw_params_get_rate(hw_params, &actual_rate, 0);
    printf("4. é‡‡æ ·ç‡: %u Hz\n", actual_rate);
    snd_pcm_uframes_t actual_buffer_frames;
    snd_pcm_hw_params_get_buffer_size(hw_params, &actual_buffer_frames);
    printf("5. ç¼“å†²æ—¶é•¿: %.2f ms\n", (double)actual_buffer_frames / actual_rate * 1000);
    printf("=======================\n\n");

    // 4. åˆ†é…ç¼“å†²åŒºï¼ˆåŒºåˆ†åŸå§‹æ•°æ®å’Œæ’­æ”¾æ•°æ®ï¼‰
    wav_buf = malloc(BUFFER_FRAMES * wav_frame_bytes);       // å­˜å‚¨WAVåŸå§‹æ•°æ®
    playback_buf = malloc(BUFFER_FRAMES * playback_frame_bytes); // å­˜å‚¨åŒå£°é“æ’­æ”¾æ•°æ®
    if (!wav_buf || !playback_buf) {
        fprintf(stderr, "å†…å­˜åˆ†é…å¤±è´¥\n");
        snd_pcm_close(pcm_handle);
        fclose(wav_file);
        free(wav_buf);
        free(playback_buf);
        return -1;
    }

    // 5. åˆå§‹åŒ–æ—¶é—´æ§åˆ¶ï¼ˆæ ¸å¿ƒï¼ï¼‰
    int is_playing = 0;
    int first_print = 1;
    uint64_t play_start_ms = 0;  // æ’­æ”¾å¼€å§‹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    uint64_t max_play_ms = (uint64_t)(wav_total_seconds * 1000);  // æœ€å¤§æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰

    // 6. æ ¸å¿ƒæ’­æ”¾å¾ªç¯ï¼ˆç»“åˆæ—¶é—´æ§åˆ¶ + å£°é“è½¬æ¢ï¼‰
    while (1) {
        // ç»ˆæ­¢æ¡ä»¶1ï¼šæ’­æ”¾æ—¶é•¿è¶…è¿‡WAVå®é™…æ—¶é•¿ï¼ˆæ ¸å¿ƒï¼ï¼‰
        if (is_playing) {
            uint64_t current_ms = get_current_ms();
            uint64_t elapsed_ms = current_ms - play_start_ms;
            if (elapsed_ms >= max_play_ms) {
                printf("\nâ° è¾¾åˆ°WAVå®é™…æ—¶é•¿ï¼ˆ%.2fç§’ï¼‰ï¼Œåœæ­¢æ’­æ”¾\n", wav_total_seconds);
                break;
            }
            // å®æ—¶æ‰“å°â€œæ—¶é—´è¿›åº¦â€ï¼ˆè€Œéå¸§æ•°ï¼‰
            printf("ğŸ“ æ’­æ”¾è¿›åº¦: %.2f/%.2f ç§’ (%.1f%%) | çŠ¶æ€: è¿è¡Œä¸­\r",
                   (double)elapsed_ms / 1000, wav_total_seconds,
                   (double)elapsed_ms / max_play_ms * 100);
            fflush(stdout);
        }

        // ç»ˆæ­¢æ¡ä»¶2ï¼šå¸§æ•°å·²å†™å®Œ ä¸” ç¼“å†²åŒºä¸ºç©ºï¼ˆé˜²æ­¢æ®‹ç•™æ•°æ®æ’­æ”¾ï¼‰
        if (frames_written >= total_frames) {
            snd_pcm_sframes_t delay_frames = snd_pcm_delay(pcm_handle, NULL);
            if (delay_frames <= 0) {
                printf("\nğŸ“ æ•°æ®å·²æ’­æ”¾å®Œæ¯•ï¼Œç¼“å†²åŒºæ— æ®‹ç•™\n");
                break;
            }
        }

        // è·å–å¯ç”¨å¸§æ•°
        snd_pcm_uframes_t avail_frames = snd_pcm_avail_update(pcm_handle);
        if (avail_frames <= 0) {
            if (avail_frames < 0) {
                ret = snd_pcm_recover(pcm_handle, avail_frames, 1);
                if (ret < 0) {
                    fprintf(stderr, "\nè®¾å¤‡æ¢å¤å¤±è´¥: %s\n", snd_strerror(ret));
                    break;
                }
            }
            usleep(1000);
            continue;
        }

        // è®¡ç®—æœ¬æ¬¡å†™å…¥å¸§æ•°
        snd_pcm_uframes_t write_frames = avail_frames;
        if (write_frames > BUFFER_FRAMES) write_frames = BUFFER_FRAMES;
        if (frames_written + write_frames > total_frames) {
            write_frames = total_frames - frames_written;
        }

        if (write_frames > 0) {
            // è¯»å–WAVåŸå§‹æ•°æ®
            int read_frames = read_wav_audio(wav_buf, write_frames);
            if (read_frames <= 0) {
                write_frames = 0;
                continue;
            }

            // æ ¸å¿ƒï¼šå£°é“è½¬æ¢
            if (wav_header.channels == 1) {
                // å•å£°é“â†’åŒå£°é“ï¼šå¤åˆ¶æ•°æ®åˆ°å·¦å³å£°é“
                mono_to_stereo((short*)wav_buf, (short*)playback_buf, read_frames);
            } else {
                // åŒå£°é“ï¼šç›´æ¥æ‹·è´
                memcpy(playback_buf, wav_buf, read_frames * playback_frame_bytes);
            }

            // MMAPå†™å…¥ï¼ˆä½¿ç”¨åŒå£°é“æ’­æ”¾æ•°æ®ï¼‰
            const snd_pcm_channel_area_t *areas;
            snd_pcm_uframes_t offset;
            ret = snd_pcm_mmap_begin(pcm_handle, &areas, &offset, &write_frames);
            
            if (ret >= 0 && write_frames > 0) {
                if (first_print) {
                    printf("\n===== MMAPç¼“å†²åŒºä¿¡æ¯ =====\n");
                    printf("åŸºåœ°å€: 0x%lx\n", (unsigned long)areas->addr);
                    first_print = 0;
                }

                char *dst = (char*)(areas->addr + offset * playback_frame_bytes);
                memcpy(dst, playback_buf, write_frames * playback_frame_bytes);
                
                ret = snd_pcm_mmap_commit(pcm_handle, offset, write_frames);
                if (ret > 0) {
                    frames_written += ret;

                    // å¯åŠ¨æ’­æ”¾å¹¶è®°å½•å¼€å§‹æ—¶é—´ï¼ˆæ ¸å¿ƒï¼ï¼‰
                    if (!is_playing) {
                        ret = snd_pcm_start(pcm_handle);
                        if (ret < 0) {
                            fprintf(stderr, "å¯åŠ¨æ’­æ”¾å¤±è´¥: %s\n", snd_strerror(ret));
                        } else {
                            is_playing = 1;
                            play_start_ms = get_current_ms();  // è®°å½•æ’­æ”¾å¼€å§‹æ—¶é—´
                            printf("âœ… æ’­æ”¾å¯åŠ¨ï¼Œå¼€å§‹è®¡æ—¶...\n");
                        }
                    }
                }
            }
        }
    }

    // 7. å¼ºåˆ¶åœæ­¢æ’­æ”¾ï¼ˆç¡®ä¿ç«‹å³ç»ˆæ­¢ï¼‰
    if (is_playing) {
        snd_pcm_drop(pcm_handle);  // æ¸…ç©ºç¼“å†²åŒºï¼Œç«‹å³åœæ­¢
        printf("âœ… å·²å¼ºåˆ¶åœæ­¢æ’­æ”¾ï¼Œç¼“å†²åŒºå·²æ¸…ç©º\n");
    }

    // 8. é‡Šæ”¾èµ„æº
    free(wav_buf);
    free(playback_buf);
    snd_pcm_close(pcm_handle);
    fclose(wav_file);
    printf("\nğŸµ æ’­æ”¾å®Œæˆï¼å®é™…æ’­æ”¾æ—¶é•¿: %.2f ç§’\n", wav_total_seconds);
    return 0;
}
